{% extends 'base.html' %}

{% block title %}Crypto Payment - Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Complete Your Crypto Payment</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.736 6.979C9.208 6.193 9.696 6 10 6c.304 0 .792.193 1.264.979.434.725.736 1.797.736 3.021s-.302 2.296-.736 3.021C10.792 13.807 10.304 14 10 14c-.304 0-.792-.193-1.264-.979C8.302 12.296 8 11.224 8 10s.302-2.296.736-3.021z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-gray-900">Send {{ order.crypto_currency }}</h2>
                <p class="text-gray-600 mt-1">Send exactly <span class="font-mono font-medium">{{ order.crypto_amount }}</span> {{ order.crypto_currency }} to complete your order</p>
            </div>
            
            <!-- Payment Address -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Address</label>
                <div class="flex">
                    <input 
                        type="text" 
                        value="{{ order.crypto_address }}" 
                        readonly 
                        class="flex-1 border border-gray-300 rounded-l-lg px-3 py-2 font-mono text-sm bg-gray-50"
                        id="crypto-address"
                    >
                    <button 
                        type="button" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors"
                        onclick="copyToClipboard('crypto-address')"
                    >
                        Copy
                    </button>
                </div>
            </div>
            
            <!-- QR Code -->
            <div class="text-center mb-6">
                <img 
                    src="{{ qr_code_url }}" 
                    alt="Payment QR Code" 
                    class="mx-auto border border-gray-200 rounded-lg"
                >
                <p class="text-sm text-gray-600 mt-2">Scan with your crypto wallet</p>
            </div>
            
            <!-- Payment Details -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-medium text-gray-900 mb-3">Payment Details</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Order:</span>
                        <span class="font-medium">{{ order.order_number }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Amount (USD):</span>
                        <span class="font-medium">${{ order.total_amount }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Amount ({{ order.crypto_currency }}):</span>
                        <span class="font-mono font-medium">{{ order.crypto_amount }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Network:</span>
                        <span class="font-medium">
                            {% if order.crypto_currency == 'BTC' %}Bitcoin
                            {% elif order.crypto_currency == 'ETH' %}Ethereum
                            {% elif order.crypto_currency == 'LTC' %}Litecoin
                            {% elif order.crypto_currency == 'USDT' %}Ethereum (USDT ERC-20)
                            {% else %}{{ order.crypto_currency }}
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Payment Status -->
            <div class="mb-6">
                <div class="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-yellow-800">Waiting for Payment</p>
                            <p class="text-xs text-yellow-700">We'll detect your payment automatically</p>
                        </div>
                    </div>
                    <button 
                        type="button" 
                        class="text-sm text-yellow-800 hover:text-yellow-900 underline"
                        onclick="checkPaymentStatus()"
                    >
                        Check Status
                    </button>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-medium text-blue-900 mb-2">Payment Instructions</h4>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>• Send exactly {{ order.crypto_amount }} {{ order.crypto_currency }} to the address above</li>
                    <li>• Payment will be confirmed after 
                        {% if order.crypto_currency == 'BTC' %}1 confirmation
                        {% elif order.crypto_currency == 'ETH' %}12 confirmations  
                        {% elif order.crypto_currency == 'LTC' %}6 confirmations
                        {% elif order.crypto_currency == 'USDT' %}12 confirmations (ERC-20)
                        {% else %}network confirmations
                        {% endif %}
                    </li>
                    <li>• Do not send from an exchange - use a personal wallet</li>
                    <li>• Keep this page open to monitor payment status</li>
                </ul>
            </div>
            
            <!-- Actions -->
            <div class="flex space-x-4">
                <a 
                    href="{% url 'orders:payment' order.order_number %}" 
                    class="flex-1 bg-gray-200 text-gray-800 text-center py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"
                >
                    Choose Different Payment Method
                </a>
                <button 
                    type="button" 
                    class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                    onclick="window.location.reload()"
                >
                    Refresh Status
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    // Show feedback
    const button = element.nextElementSibling;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.classList.add('bg-green-600', 'hover:bg-green-700');
    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-600', 'hover:bg-green-700');
        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }, 2000);
}

function checkPaymentStatus() {
    // In a real app, this would make an AJAX call to check payment status
    fetch(`/orders/crypto-payment/{{ order.order_number }}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.paid) {
                window.location.href = '{% url "orders:order_confirmation" order.order_number %}';
            } else {
                alert('Payment not yet received. Please wait a few more minutes and try again.');
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Auto-refresh every 30 seconds to check for payment
setInterval(() => {
    checkPaymentStatus();
}, 30000);
</script>
{% endblock %}